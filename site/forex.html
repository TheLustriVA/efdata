<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUD Exchange Rate World Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        #map {
            height: 70vh; /* Responsive height */
            width: 100%;
            max-width: 1200px; /* Max width for larger screens */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            margin-top: 1rem;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.375rem; /* Rounded corners for popups */
        }
        .leaflet-popup-content {
            font-size: 0.875rem; /* 14px */
            line-height: 1.25rem; /* 20px */
        }
        .legend {
            padding: 0.75rem; /* 12px */
            background: white;
            background: rgba(255,255,255,0.9); /* Slightly transparent white */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border-radius: 0.375rem; /* Rounded corners */
            line-height: 1.5rem; /* 24px */
            font-size: 0.875rem; /* 14px */
        }
        .legend i {
            width: 1.125rem; /* 18px */
            height: 1.125rem; /* 18px */
            float: left;
            margin-right: 0.5rem; /* 8px */
            opacity: 0.8;
            border-radius: 0.125rem; /* Slightly rounded color boxes */
        }
        /* Custom message box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Ensure it's on top */
        }
        .message-box-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 400px; /* Fixed width for the message box */
        }
        .message-box-content h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .message-box-content p {
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        .message-box-button {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message-box-button:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center py-6">
            <h1 class="text-3xl font-bold text-gray-800">AUD Exchange Rate Viewer</h1>
            <p class="text-md text-gray-600 mt-2">Interactive map showing AUD exchange rates against various currencies.</p>
            <p class="text-sm text-gray-500 mt-1">(Rates are from API: Foreign Currency Units per 1 AUD)</p>
        </header>

        <div id="map"></div>

        <div id="customMessageBox" class="message-box-overlay">
            <div class="message-box-content">
                <h3 id="messageBoxTitle">Notification</h3>
                <p id="messageBoxText">This is a message.</p>
                <button id="messageBoxButton" class="message-box-button">OK</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- Custom Message Box Logic ---
        const messageBoxOverlay = document.getElementById('customMessageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxButton = document.getElementById('messageBoxButton');

        function showMessage(title, text) {
            messageBoxTitle.textContent = title;
            messageBoxText.textContent = text;
            messageBoxOverlay.style.display = 'flex';
        }

        messageBoxButton.addEventListener('click', () => {
            messageBoxOverlay.style.display = 'none';
        });
        // --- End Custom Message Box Logic ---

        // Initialize the map and set its view to a global perspective
        const map = L.map('map').setView([20, 0], 2); // Centered more globally, zoom level 2

        // Add a tile layer to the map (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // This variable will hold the GeoJSON layer once created
        let geoJsonLayer;
        
        // This will hold the processed exchange rate data, keyed by ISO A3 country code
        let processedCountryData = {};


        // Function to determine color based on exchange rate
        function getColor(rate) {
            if (rate === undefined || rate === null) return '#D3D3D3'; // Default grey for no data
            if (rate === 1.00) return '#4CAF50'; // Green for AUD itself (if AUD/AUD rate is 1)

            if (rate > 50) return '#006400';    // Dark Green
            if (rate > 5) return '#228B22';     // Forest Green
            if (rate > 1.05) return '#90EE90';   // Light Green
            if (rate >= 0.80 && rate <= 1.05) return '#FFFFE0'; // Light Yellow (near parity)
            if (rate >= 0.60 && rate < 0.80) return '#FFD700';   // Gold/Orange
            return '#FF6347'; // Tomato Red (AUD is weaker)
        }

        // Main function to fetch data and initialize the map
        async function initializeMapWithApiData() {
            try {
                // --- 1. Get API Data ---
                const apiEndpoint = 'http://127.0.0.1:8222/';
                console.log(`Fetching exchange rates from: ${apiEndpoint}`);

                // IMPORTANT: For 'NetworkError when attempting to fetch resource.'
                // This error often indicates a CORS (Cross-Origin Resource Sharing) issue.
                // Your FastAPI server at 'http://127.0.0.1:8222/' MUST be configured
                // to send appropriate CORS headers (e.g., 'Access-Control-Allow-Origin')
                // to allow requests from the origin this HTML page is served from
                // (e.g., 'file://', 'http://localhost:xxxx', or 'http://127.0.0.1:xxxx').
                // See the conversation for an example of how to set up CORS in FastAPI.
                // Also, ensure your FastAPI server is running and accessible.

                const apiResponseRaw = await fetch(apiEndpoint, {
                    mode: 'cors' // Explicitly set mode to CORS.
                });
                
                if (!apiResponseRaw.ok) {
                    // If the HTTP response status is not OK, throw an error
                    throw new Error(`API error! Status: ${apiResponseRaw.status} ${apiResponseRaw.statusText}. Failed to fetch from ${apiEndpoint}. Check server logs and CORS configuration.`);
                }
                
                const apiData = await apiResponseRaw.json();
                console.log("Successfully fetched API data:", apiData);

                if (!apiData || !apiData.price_list || !Array.isArray(apiData.price_list)) {
                    throw new Error("API data is not in the expected format (missing 'price_list' array).");
                }

                // --- 2. Prepare API data for lookup by country name ---
                const apiCountryDataMap = new Map();
                apiData.price_list.forEach(item => {
                    if (item.country && typeof item.country === 'string') {
                        const normalizedApiCountryName = item.country.toLowerCase().trim();
                        apiCountryDataMap.set(normalizedApiCountryName, {
                            rate: item.exchange_rate,
                            currency: item.target_currency,
                            apiOriginalCountryName: item.country 
                        });
                    }
                });

                // --- 3. Fetch GeoJSON Country Data ---
                const geoJsonURL = 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json';
                console.log(`Fetching GeoJSON from: ${geoJsonURL}`);
                const geoJsonResponse = await fetch(geoJsonURL);
                if (!geoJsonResponse.ok) {
                    throw new Error(`GeoJSON fetch error! status: ${geoJsonResponse.status}. Failed to fetch from ${geoJsonURL}`);
                }
                const geoJsonData = await geoJsonResponse.json();
                console.log("Successfully fetched GeoJSON data.");


                // --- 4. Combine API data with GeoJSON data ---
                processedCountryData = {}; // Reset before processing
                geoJsonData.features.forEach(feature => {
                    const isoA3 = feature.id; 
                    const geoJsonCountryName = feature.properties.name; 

                    if (!isoA3 || !geoJsonCountryName || typeof geoJsonCountryName !== 'string') {
                        return; 
                    }
                    
                    const normalizedGeoJsonCountryName = geoJsonCountryName.toLowerCase().trim();
                    let matchedApiData = apiCountryDataMap.get(normalizedGeoJsonCountryName);

                    if (!matchedApiData) {
                        const variations = {
                            "united states of america": "united states",
                            "russian federation": "russia",
                            "republic of korea": "south korea",
                            "iran (islamic republic of)": "iran",
                            "syrian arab republic": "syria",
                            "viet nam": "vietnam",
                            "bolivia (plurinational state of)": "bolivia",
                            "venezuela (bolivarian republic of)": "venezuela",
                            "czechia": "czech republic",
                            "brunei darussalam": "brunei",
                            "c√¥te d'ivoire": "ivory coast",
                            "lao people's democratic republic": "laos",
                            "tanzania, united republic of": "tanzania",
                            "moldova, republic of": "moldova",
                            "macedonia, the former yugoslav republic of": "north macedonia", // Common GeoJSON name
                            "palestine, state of": "palestine",
                            "united republic of tanzania": "tanzania", // Another common GeoJSON variation
                            "congo, the democratic republic of the": "democratic republic of the congo",
                            "timor-leste": "east timor" // API might use East Timor
                        };
                        const apiNameToTry = variations[normalizedGeoJsonCountryName];
                        if (apiNameToTry) {
                           matchedApiData = apiCountryDataMap.get(apiNameToTry);
                        }
                    }

                    if (matchedApiData) {
                        processedCountryData[isoA3] = {
                            rate: matchedApiData.rate,
                            currencyCode: matchedApiData.currency,
                            geoJsonDisplayName: geoJsonCountryName,
                            apiOriginalCountryName: matchedApiData.apiOriginalCountryName
                        };
                    }
                });
                
                const totalGeoJsonCountries = geoJsonData.features.length;
                const matchedGeoJsonCountries = Object.keys(processedCountryData).length;
                console.log(`Processed ${totalGeoJsonCountries} GeoJSON features. Matched ${matchedGeoJsonCountries} to API data.`);
                if (matchedGeoJsonCountries < totalGeoJsonCountries * 0.75) { 
                     console.warn(`Warning: Only ${((matchedGeoJsonCountries/totalGeoJsonCountries)*100).toFixed(1)}% of GeoJSON countries were matched. Review country name discrepancies.`);
                }


                // --- 5. Create GeoJSON Layer with Styles and Popups ---
                if (geoJsonLayer) { 
                    map.removeLayer(geoJsonLayer);
                }
                geoJsonLayer = L.geoJson(geoJsonData, {
                    style: function(feature) {
                        const countryInfo = processedCountryData[feature.id];
                        const rate = countryInfo ? countryInfo.rate : undefined;
                        return {
                            fillColor: getColor(rate),
                            weight: 1,
                            opacity: 1,
                            color: 'white', 
                            fillOpacity: 0.75 
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const countryInfo = processedCountryData[feature.id];
                        const displayName = feature.properties.name || "Unknown Country";
                        let popupContent = `<strong>${displayName}</strong><br>`;

                        if (countryInfo) {
                            popupContent += `1 AUD = ${countryInfo.rate.toFixed(2)} ${countryInfo.currencyCode}`;
                        } else {
                            popupContent += 'Exchange rate data not available.';
                        }
                        layer.bindPopup(popupContent);

                        layer.on('mouseover', function (e) {
                            this.setStyle({ weight: 2.5, color: '#555', fillOpacity: 0.9 });
                            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                this.bringToFront();
                            }
                        });
                        layer.on('mouseout', function (e) {
                            if (geoJsonLayer) { 
                                geoJsonLayer.resetStyle(this);
                            }
                        });
                    }
                }).addTo(map);

                addLegend();

            } catch (error) {
                console.error('Error initializing map with API data:', error);
                showMessage('Map Initialization Error', `Could not load map data. ${error.message}. Check console for details. Ensure your local API at http://127.0.0.1:8222/ is running and accessible, and that it has CORS enabled if this page is served from a different origin (e.g., file://).`);
            }
        }

        // Add a legend to the map
        function addLegend() {
            const existingLegend = document.querySelector('.info.legend');
            if (existingLegend) {
                existingLegend.remove();
            }

            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [
                    {label: '< 0.60 (AUD Weaker)', color: '#FF6347'}, 
                    {label: '0.60 - 0.79', color: '#FFD700'},   
                    {label: '0.80 - 1.05 (Near Parity)', color: '#FFFFE0'}, 
                    {label: '1.05 - 4.99', color: '#90EE90'},   
                    {label: '5.00 - 49.99', color: '#228B22'},     
                    {label: '> 50.00 (AUD Stronger)', color: '#006400'},    
                    {label: 'AUD (Reference)', color: '#4CAF50'}, 
                    {label: 'No Data', color: '#D3D3D3'} 
                ];

                div.innerHTML += '<strong class="text-sm">AUD Exchange Rate Strength</strong><br>';
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + grades[i].color + '"></i> ' +
                        grades[i].label + '<br>';
                }
                return div;
            };
            legend.addTo(map);
        }

        // Handle window resize to ensure map is responsive
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });

        // Call the main initialization function when the script loads
        initializeMapWithApiData();

    </script>
</body>
</html>
